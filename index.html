<!doctype html>
<html class="no-js"
      lang="">
    <head>
        <link rel="stylesheet"
              type="text/css"
              href="/assets/css/style.min.css"/>
        <script src="/assets/js/dependencies.js"></script>
        <title>FliebertJS</title>
    </head>
    <body>
        <script src="http://mobs.dev:35729/livereload.js?snipver=1"></script>
        <script src="/assets/js/simulation-min.js"></script>


        <canvas id="world"
                width="500"
                height="500"
                style="border: 1px solid black;"></canvas>

        <div>Showing: <strong id="currentTick">0</strong> / <strong id="bufferSize">0</strong></div>


        <script>
            const bufferDisplay = document.getElementById('bufferSize');
            const tickDisplay = document.getElementById('currentTick');

            const runner = new Runner();
            const buffer = runner.getBuffer();
            const world = new World();
            const renderer = new Renderer('#world', buffer);

            const trailMobs = [];

            for (var i = 0; i < 10000; i++) {
                const mob = new TrailMob(world.getRandomPosition());
                mob.applyForce(new Vector(Math.random() * 4 - 2, Math.random() * 4 - 2));
                world.add(mob);
                trailMobs.push(mob);
            }

            runner.setWorld(world);
            runner.onTick(function () {
                bufferDisplay.innerText = buffer.getSize();
            });
            renderer.onDraw(function (tick) {
                tickDisplay.innerText = tick;
            });

            renderer.el.onmousedown = function (e) {
                var clickVector = new Vector(e.offsetX, e.offsetY);

                trailMobs.forEach(function (mob) {
                    var force = clickVector.clone()
                            .subtract(mob.getLocation())
                            .divide(200);
                    mob.applyForce(force);
                });
            };

            function play() {
                renderer.play();
            }

            function pause() {
                renderer.stop();
            }

            function stop() {
                renderer.stop();
                renderer.setCurrentFrame(0);
                renderer.clearScene();
            }

            function firstFrame() {
                renderer.stop();
                renderer.setCurrentFrame(0);
                renderer.draw();
            }

            function lastFrame() {
                renderer.stop();
                renderer.setCurrentFrame(
                        buffer.getLastTick() *
                        renderer.getTickRate()
                );
                renderer.draw();
            }


            function nextFrame() {
                renderer.stop();
                renderer.setCurrentFrame(
                        (renderer.getVisibleTick() + 1) *
                        renderer.getTickRate()
                );
                renderer.draw();
            }


            function previousFrame() {
                renderer.stop();
                renderer.setCurrentFrame(
                        (renderer.getVisibleTick() - 1) *
                        renderer.getTickRate()
                );
                renderer.draw();
            }

            function startLiveMode() {
                runner.simulate(2);

                renderer.setLiveMode(true);
                renderer.onDraw(function () {
                    runner.simulate(1);
                });

                renderer.play();
            }
            function stopLiveMode() {
                renderer.stop();
                renderer.setLiveMode(false);
                renderer.clearOnDraw();
                renderer.onDraw(function (tick) {
                    tickDisplay.innerText = tick;
                });
            }
        </script>

        <div>
            <button onclick="runner.simulate(10)">Simulate 10</button>
            <button onclick="runner.simulate(100)">Simulate 100</button>
            <button onclick="runner.simulate(1000)">Simulate 1000</button>

            <button onclick="startLiveMode()">Start live</button>
            <button onclick="stopLiveMode()">Stop live</button>
        </div>

        <div>
            <button onclick="firstFrame()">|<<</button>
            <button onclick="previousFrame()"><</button>
            <button onclick="play()">play</button>
            <button onclick="pause()">pause</button>
            <button onclick="stop()">stop</button>
            <button onclick="nextFrame()">></button>
            <button onclick="lastFrame()">>>|</button>
        </div>
    </body>
</html>